-- ============================================================
-- Query 3: Daily Market Prices with Short-Term Trend Indicator
-- Purpose: Analyse daily market price movements and smooth short-term volatility using a 7-day rolling average.
-- ============================================================

SELECT
    t.trade_id,
    CAST(t.trade_date AS date) AS trade_date,
    t.buy_sell,
    t.volume_barrels,
    ROUND(CAST(t.trade_price_usd AS float), 2) AS trade_price_usd,
    ROUND(CAST(p.market_price_usd AS float), 2) AS market_price_usd,
    ROUND(
        CASE 
            WHEN t.buy_sell = 'Buy'
            THEN (CAST(p.market_price_usd AS float) - CAST(t.trade_price_usd AS float)) * t.volume_barrels
            ELSE (CAST(t.trade_price_usd AS float) - CAST(p.market_price_usd AS float)) * t.volume_barrels
        END,
        2
    ) AS estimated_value_impact_usd
FROM trades_large t
JOIN market_prices_large p
    ON CAST(t.trade_date AS date) = CAST(p.[date] AS date)
ORDER BY trade_date, trade_id;

O/P

trade_id	trade_date	buy_sell	volume_barrels	trade_price_usd	market_price_usd	estimated_value_impact_usd
T0017	2023-10-03	Buy	129780	82.77	82.22	-71379
T0061	2023-10-05	Sell	77080	79.1	83.52	-340693.6
T0067	2023-10-09	Sell	74578	75.94	83.24	-544419.4
T0012	2023-10-10	Buy	100566	82.89	84.18	129730.14
T0051	2023-10-11	Sell	66962	76.51	84.64	-544401.06
T0104	2023-10-11	Buy	151732	87.42	84.64	-421814.96
T0021	2023-10-12	Buy	128461	80.2	84.36	534397.76
T0009	2023-10-16	Buy	127508	93.31	84.41	-1134821.2
T0098	2023-10-18	Sell	139835	90.93	84.28	929902.75
T0119	2023-10-20	Sell	70354	94.46	82.09	870278.98
T0064	2023-10-24	Sell	75909	79.14	81.15	-152577.09
T0091	2023-10-24	Buy	92224	89.53	81.15	-772837.12
T0079	2023-10-25	Buy	126188	84.6	81.34	-411372.88
T0102	2023-10-27	Sell	122848	76.32	79.94	-444709.76
T0040	2023-10-30	Buy	61677	84.61	80.82	-233755.83
T0054	2023-10-30	Sell	82348	90	80.82	755954.64
T0047	2023-10-31	Sell	59065	76.27	80.69	-261067.3
T0071	2023-11-02	Sell	66790	84.52	79.87	310573.5
T0085	2023-11-02	Buy	95771	87.35	79.87	-716367.08
T0080	2023-11-03	Sell	44748	83.41	79.55	172727.28
T0095	2023-11-06	Buy	101629	80.96	79.61	-137199.15
T0052	2023-11-07	Buy	68295	88.83	78.92	-676803.45
T0053	2023-11-07	Sell	53807	85.69	78.92	364273.39
T0057	2023-11-08	Sell	146995	89.52	79.15	1524338.15
T0055	2023-11-10	Buy	66432	93.26	78.61	-973228.8
T0087	2023-11-14	Buy	53116	87.16	79.36	-414304.8
T0109	2023-11-14	Buy	62700	85.75	79.36	-400653
T0039	2023-11-15	Buy	41542	90.55	79.36	-464854.98
T0044	2023-11-15	Sell	102856	82.86	79.36	359996
T0062	2023-11-17	Sell	41324	80.03	79.21	33885.68
T0101	2023-11-20	Sell	73591	90.38	78.48	875732.9
T0020	2023-11-21	Buy	51174	82.21	78.61	-184226.4
T0070	2023-11-21	Sell	143605	84.96	78.61	911891.75
T0048	2023-11-22	Sell	123460	75.74	77.43	-208647.4
T0005	2023-11-23	Sell	142795	94.92	76.63	2611720.55
T0094	2023-11-23	Buy	120219	93.21	76.63	-1993231.02
T0010	2023-11-28	Sell	145955	94.17	77.3	2462260.85
T0093	2023-11-29	Sell	148492	84.02	77.23	1008260.68
T0065	2023-12-04	Sell	129339	92.56	75.73	2176775.37
T0073	2023-12-04	Sell	65289	81.16	75.73	354519.27
T0019	2023-12-06	Buy	61689	80.32	76.09	-260944.47
T0023	2023-12-06	Sell	49348	75.65	76.09	-21713.12
T0041	2023-12-06	Buy	86732	94.71	76.09	-1614949.84
T0060	2023-12-06	Sell	80262	79.82	76.09	299377.26
T0063	2023-12-07	Sell	131267	80.49	76.29	551321.4
T0117	2023-12-07	Buy	61732	92.49	76.29	-1000058.4
T0097	2023-12-08	Sell	139518	88.95	75.24	1912791.78
T0050	2023-12-11	Buy	94693	75.27	75.43	15150.88
T0111	2023-12-11	Buy	143214	86.7	75.43	-1614021.78
T0003	2023-12-12	Sell	48335	79.34	75.2	200106.9
T0024	2023-12-14	Buy	63714	80.6	75.16	-346604.16
T0037	2023-12-14	Sell	117052	78.3	75.16	367543.28
T0081	2023-12-14	Buy	126769	90.69	75.16	-1968722.57
T0120	2023-12-14	Buy	53843	87.04	75.16	-639654.84
T0100	2023-12-19	Buy	63960	91.84	75.83	-1023999.6
T0082	2023-12-20	Sell	49435	87.79	75.65	600140.9
T0114	2023-12-20	Buy	133396	78.6	75.65	-393518.2
T0115	2023-12-20	Sell	101642	88.93	75.65	1349805.76
T0015	2023-12-22	Buy	41062	78.39	76.43	-80481.52
T0099	2023-12-22	Buy	68016	84.19	76.43	-527804.16
T0059	2023-12-25	Buy	97854	82.56	76.14	-628222.68
T0112	2023-12-27	Buy	60559	83.01	75.37	-462670.76
T0103	2023-12-29	Sell	143333	75.92	75.14	111799.74
T0108	2024-01-01	Buy	151276	81.83	75.95	-889502.88
T0077	2024-01-02	Buy	55485	90.84	75.91	-828391.05
T0083	2024-01-02	Buy	43709	91.1	75.91	-663939.71
T0038	2024-01-03	Buy	84261	83.23	76.51	-566233.92
T0118	2024-01-05	Sell	131362	85.3	76.34	1177003.52
T0027	2024-01-12	Buy	142634	80.42	76.83	-512056.06
T0006	2024-01-23	Buy	129112	88.94	76.14	-1652633.6
T0036	2024-01-23	Buy	112592	86.03	76.14	-1113534.88
T0030	2024-01-25	Sell	143150	93.81	76.71	2447865
T0088	2024-01-29	Sell	65470	87.73	75.93	772546
T0110	2024-01-29	Buy	74620	84.2	75.93	-617107.4
T0116	2024-01-29	Sell	116539	83.23	75.93	850734.7
T0001	2024-02-02	Buy	100921	76.51	76.66	15138.15
T0013	2024-02-02	Sell	106703	77.14	76.66	51217.44
T0106	2024-02-06	Sell	107641	79.18	77.3	202365.08
T0033	2024-02-07	Sell	63625	93.38	76.88	1049812.5
T0072	2024-02-07	Sell	158874	91.63	76.88	2343391.5
T0074	2024-02-09	Sell	95129	91.33	76.45	1415519.52
T0002	2024-02-12	Buy	45486	78.32	75.57	-125086.5
T0056	2024-02-13	Buy	123285	86.7	75.75	-1349970.75
T0107	2024-02-14	Buy	76395	86.59	75.91	-815898.6
T0011	2024-02-15	Buy	158324	76.16	75.91	-39581
T0022	2024-02-15	Buy	143033	84.06	75.91	-1165718.95
T0032	2024-02-15	Buy	88136	86.62	75.91	-943936.56
T0068	2024-02-15	Sell	112124	80.37	75.91	500073.04
T0075	2024-02-15	Buy	133714	94.36	75.91	-2467023.3
T0096	2024-02-15	Sell	106040	85.47	75.91	1013742.4
T0007	2024-02-22	Sell	137203	82.68	73.98	1193666.1
T0029	2024-02-22	Buy	46801	76.52	73.98	-118874.54
T0084	2024-02-22	Sell	70355	93.06	73.98	1342373.4
T0092	2024-02-22	Buy	79298	85.95	73.98	-949197.06
T0049	2024-02-29	Buy	128092	77.68	75.52	-276678.72
T0035	2024-03-01	Sell	140843	92.53	75.47	2402781.58
T0058	2024-03-04	Buy	131792	90.14	74.32	-2084949.44
T0014	2024-03-05	Sell	67192	81.71	74.31	497220.8
T0031	2024-03-05	Sell	112267	83.33	74.31	1012648.34
T0016	2024-03-06	Buy	124076	87.94	74.34	-1687433.6
T0028	2024-03-06	Buy	129930	77.66	74.34	-431367.6
T0086	2024-03-07	Buy	97799	94.61	75.82	-1837643.21
T0045	2024-03-08	Buy	133105	91.58	75.7	-2113707.4
T0105	2024-03-08	Sell	154821	81.95	75.7	967631.25
T0026	2024-03-11	Buy	114460	87.06	75.89	-1278518.2
T0076	2024-03-11	Buy	134246	76.77	75.89	-118136.48
T0066	2024-03-12	Sell	59870	90.14	75.86	854943.6
T0046	2024-03-14	Buy	128858	86.38	75.85	-1356874.74
T0025	2024-03-15	Sell	78102	83.22	76.3	540465.84
T0069	2024-03-21	Buy	157611	75.44	76.23	124512.69
T0113	2024-03-22	Buy	133045	88.95	76.58	-1645766.65
T0089	2024-03-26	Buy	82344	86.1	77.3	-724627.2
T0004	2024-03-27	Buy	126900	80.89	76.96	-498717
T0034	2024-03-27	Buy	122873	76.65	76.96	38090.63
T0042	2024-03-27	Buy	90343	82.53	76.96	-503210.51
T0043	2024-03-27	Buy	79081	89.99	76.96	-1030425.43
T0078	2024-03-27	Buy	84482	86.8	76.96	-831302.88
T0008	2024-03-28	Buy	51130	89.74	77.02	-650373.6
T0018	2024-03-28	Sell	61545	79.59	77.02	158170.65
T0090	2024-03-29	Sell	82918	76.82	76.72	8291.8

